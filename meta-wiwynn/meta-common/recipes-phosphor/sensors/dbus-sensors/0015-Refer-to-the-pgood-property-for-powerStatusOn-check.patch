From 7ebd0cca9d26f47e24d23e29c5ca4331462a78a7 Mon Sep 17 00:00:00 2001
From: Frederick Lee <Frederick_Lee@wiwynn.com>
Date: Mon, 16 Dec 2019 17:20:52 +0800
Subject: [PATCH] Refer to the pgood property for powerStatusOn checking

---
 include/Utils.hpp |  8 ++++----
 src/Utils.cpp     | 12 +++++-------
 2 files changed, 9 insertions(+), 11 deletions(-)

diff --git a/include/Utils.hpp b/include/Utils.hpp
index 3afacd5..d174ad4 100644
--- a/include/Utils.hpp
+++ b/include/Utils.hpp
@@ -92,10 +92,10 @@ constexpr const char* get = "Get";
 
 namespace power
 {
-const static constexpr char* busname = "xyz.openbmc_project.State.Host";
-const static constexpr char* interface = "xyz.openbmc_project.State.Host";
-const static constexpr char* path = "/xyz/openbmc_project/state/host0";
-const static constexpr char* property = "CurrentHostState";
+const static constexpr char* busname = "org.openbmc.control.Power";
+const static constexpr char* path = "/org/openbmc/control/power0";
+const static constexpr char* interface = "org.openbmc.control.Power";
+const static constexpr char* property = "pgood";
 } // namespace power
 namespace post
 {
diff --git a/src/Utils.cpp b/src/Utils.cpp
index 48921cc..47b6940 100644
--- a/src/Utils.cpp
+++ b/src/Utils.cpp
@@ -234,15 +234,14 @@ void setupPowerMatch(const std::shared_ptr<sdbusplus::asio::connection>& conn)
             std::string(power::interface) + "'",
         [](sdbusplus::message::message& message) {
             std::string objectName;
-            boost::container::flat_map<std::string, std::variant<std::string>>
+            boost::container::flat_map<std::string, std::variant<int>>
                 values;
             message.read(objectName, values);
             auto findState = values.find(power::property);
             if (findState != values.end())
             {
-                bool on = boost::ends_with(
-                    std::get<std::string>(findState->second), "Running");
-                if (!on)
+                int on = std::get<int>(findState->second);
+                if ( 1 != on)
                 {
                     timer.cancel();
                     powerStatusOn = false;
@@ -285,15 +284,14 @@ void setupPowerMatch(const std::shared_ptr<sdbusplus::asio::connection>& conn)
 
     conn->async_method_call(
         [](boost::system::error_code ec,
-           const std::variant<std::string>& state) {
+           const std::variant<int>& state) {
             if (ec)
             {
                 // we commonly come up before power control, we'll capture the
                 // property change later
                 return;
             }
-            powerStatusOn =
-                boost::ends_with(std::get<std::string>(state), "Running");
+            powerStatusOn = (1 == (std::get<int>(state))) ? true : false;
         },
         power::busname, power::path, properties::interface, properties::get,
         power::interface, power::property);
-- 
2.24.1

