From e1517256726a660ff3aaca929d36867418fde918 Mon Sep 17 00:00:00 2001
From: Eilin <eilin_li@wiwynn.com>
Date: Tue, 26 Jan 2021 10:43:06 +0800
Subject: [PATCH] Support IceLake version for peci driver

---
 drivers/hwmon/peci-dimmtemp.c         | 4 ++++
 drivers/mfd/intel-peci-client.c       | 6 ++++++
 include/linux/mfd/intel-peci-client.h | 8 +++++++-
 3 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/drivers/hwmon/peci-dimmtemp.c b/drivers/hwmon/peci-dimmtemp.c
index 1555bfdefabd..3e373cf83101 100644
--- a/drivers/hwmon/peci-dimmtemp.c
+++ b/drivers/hwmon/peci-dimmtemp.c
@@ -37,6 +37,7 @@ static const u8 support_model[4] = {
 	INTEL_FAM6_BROADWELL_X,
 	INTEL_FAM6_SKYLAKE_X,
 	INTEL_FAM6_SKYLAKE_XD,
+	INTEL_FAM6_ICELAKE_X,
 };
 
 static inline int read_ddr_dimm_temp_config(struct peci_dimmtemp *priv,
@@ -66,6 +67,9 @@ static int get_dimm_temp(struct peci_dimmtemp *priv, int dimm_no)
 	priv->temp[dimm_no].value = cfg_data[dimm_order] * 1000;
 
 	switch (priv->gen_info->model) {
+	case INTEL_FAM6_ICELAKE_X:
+		//todo
+		break;
 	case INTEL_FAM6_SKYLAKE_X:
 		rp_msg.addr = priv->mgr->client->addr;
 		rp_msg.bus = 2;
diff --git a/drivers/mfd/intel-peci-client.c b/drivers/mfd/intel-peci-client.c
index 24f15438634c..9f9b4c585f5f 100644
--- a/drivers/mfd/intel-peci-client.c
+++ b/drivers/mfd/intel-peci-client.c
@@ -48,6 +48,12 @@ static const struct cpu_gen_info cpu_gen_info_table[] = {
 		.core_max      = CORE_MAX_ON_SKXD,
 		.chan_rank_max = CHAN_RANK_MAX_ON_SKXD,
 		.dimm_idx_max  = DIMM_IDX_MAX_ON_SKXD },
+	{ /* Icelake Xeon*/
+		.family        = INTEL_FAM6,
+		.model         = INTEL_FAM6_ICELAKE_X,
+		.core_max      = CORE_MAX_ON_ICEX,
+		.chan_rank_max = CHAN_RANK_MAX_ON_ICEX,
+		.dimm_idx_max  = DIMM_IDX_MAX_ON_ICEX },
 };
 
 static int peci_client_get_cpu_gen_info(struct peci_client_manager *priv)
diff --git a/include/linux/mfd/intel-peci-client.h b/include/linux/mfd/intel-peci-client.h
index 7668d0cfa843..e55714a23bae 100644
--- a/include/linux/mfd/intel-peci-client.h
+++ b/include/linux/mfd/intel-peci-client.h
@@ -18,6 +18,7 @@
 #define INTEL_FAM6_BROADWELL_X		0x4F
 #define INTEL_FAM6_SKYLAKE_X		0x55
 #define INTEL_FAM6_SKYLAKE_XD		0x56
+#define INTEL_FAM6_ICELAKE_X		0x6A
 #endif
 
 #define INTEL_FAM6             6 /* P6 (Pentium Pro and later) */
@@ -38,7 +39,12 @@
 #define CHAN_RANK_MAX_ON_SKXD  2  /* Max number of channel ranks on Skylake D */
 #define DIMM_IDX_MAX_ON_SKXD   2  /* Max DIMM index per channel on Skylake D */
 
-#define CORE_NUMS_MAX          CORE_MAX_ON_SKX
+#define CORE_MAX_ON_ICEX        32 /* Max number of cores on Icelake */
+#define CHAN_RANK_MAX_ON_ICEX   8  /* Max number of channel ranks on Icelake */
+#define DIMM_IDX_MAX_ON_ICEX    3  /* Max DIMM index per channel on Icelake */
+
+//#define CORE_NUMS_MAX          CORE_MAX_ON_SKX
+#define CORE_NUMS_MAX          CORE_MAX_ON_ICEX
 #define CHAN_RANK_MAX          CHAN_RANK_MAX_ON_HSX
 #define DIMM_IDX_MAX           DIMM_IDX_MAX_ON_HSX
 #define DIMM_NUMS_MAX          (CHAN_RANK_MAX * DIMM_IDX_MAX)
-- 
2.17.1

